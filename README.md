# Dev: Расширенная Архитектура Self-Hosted CI/CD

**Dev** — это корпоративная платформа управления жизненным циклом приложений (ALM) и CI/CD, полностью развернутая на **собственном аппаратном/виртуальном обеспечении (on-premise)**. Система спроектирована для обработки высокой нагрузки от 24+ проектов, обеспечивая полную изоляцию сред и безопасности данных.

**Оркестратор:** **GitLab Community/Enterprise Edition (Self-Managed)**.

---

## 1. Детализированная Архитектура и Топология

Архитектура базируется на трех уровнях обеспечения: Control, Execution и Storage.

### 1.1. Control Plane (GitLab Master Cluster)

Этот уровень отвечает за принятие решений, хранение метаданных и управление задачами. Развертывание ведется в режиме высокой доступности (HA) для минимизации единой точки отказа.

| Компонент | Технология | Оценочные Ресурсы | Назначение |
| :--- | :--- | :--- | :--- |
| **GitLab Master Nodes (2 шт)** | GitLab HA Setup | 8 vCPU / 16 GB RAM на узел | Обработка API, веб-интерфейс, планирование CI. |
| **PostgreSQL Cluster (3 шт)** | Patroni/Streaming Replication | 4 vCPU / 8 GB RAM на узел | Хранение метаданных GitLab, конфигураций, задач. |
| **Redis Cache (2 шт)** | Sentinel | 2 vCPU / 4 GB RAM на узел | Кеширование сессий и очередей Redis. |

### 1.2. Execution Plane (Runner Hosts)

Для обеспечения безопасности и производительности, рабочие нагрузки Runner'ов разделены тегами.

| Группа Runner'ов | Тег (GitLab CI) | Количество VM (Пример) | Ресурсы на VM | Назначение |
| :--- | :--- | :--- | :--- | :--- |
| **Development Pool** | `ci-developer` | 6 – 12 (Эластично) | 16 vCPU / 32 GB RAM | Быстрые сборки, интеграционные тесты, создание образов. |
| **Production Pool** | `prod-deploy` | 4 (Статично) | 8 vCPU / 16 GB RAM | Критические деплои, миграции, smoke-тесты. |
| **Security Scanners** | `security-scan` | 2 (Статично) | 4 vCPU / 8 GB RAM | Запуск Trivy, SAST/DAST без влияния на CI-скорость. |

**Исполнитель:** Используется **Docker Executor** для обеспечения полной изоляции сред сборки от хоста Runner'а.

### 1.3. Storage & Artifact Management

*   **Artifact Storage:** **MinIO Cluster (3 узла)**, настроенный на WORM-политики, для хранения собранных Docker-образов и прочих артефактов.
    *   *Ресурс:* 4 vCPU / 8 GB RAM на узел, с выделением **10+ TB** дискового пространства.
*   **Configuration Files:** Управление конфигурацией хостов и их первоначальная настройка через **Ansible**.

---

## 2. Процессы и Языковой Стек

### Infrastructure as Code (IaC)
Вся инфраструктура (включая развертывание самих Runner'ов и их масштабирование) управляется через **Terraform**. Это гарантирует, что среда тестирования идентична производственной.

### CI/CD Workflow (GitLab CI/CD)
Пайплайны в `.gitlab-ci.yml` строго следуют принципу "сдвига влево" (Shift Left):
1.  **Checkout & Linting:** Проверка синтаксиса и стилистики кода.
2.  **Security Scan:** Запуск статических анализаторов (SAST) и сканирование зависимостей.
3.  **Build & Unit Test:** Сборка артефактов и запуск юнит-тестов.
4.  **Integration/E2E Test (Dev/Staging):** Развертывание в изолированное окружение для комплексного тестирования.
5.  **Production Deployment:** Ручное или автоматическое триггирование деплоя в Prod через `prod-deploy` Runners с использованием Ansible.

### Основные Языки Проекта

Код, который проходит через эти пайплайны, демонстрирует доминирование современного веб-стека:

*   **TypeScript / TSX:** Основной язык для логики приложений, фронтенда и утилит взаимодействия с API.
*   **Python:** Используется для скриптов автоматизации (например, взаимодействия с MinIO API, написания сложных Ansible модулей).
*   **Go / Rust:** (В меньшей степени) Может использоваться для написания низкоуровневых агентов или высокопроизводительных микросервисов.










# Dev Pro: Hybrid CI/CD с Контекстуализацией Облачных Ресурсов

**Dev Pro** — это гибридная платформа CI/CD, которая объединяет локальный Control Plane с эластичными, управляемыми ресурсами, предоставляемыми внешней публичной облачной инфраструктурой. Центральной целью является использование **Managed Kubernetes Service** для обеспечения эластичности и масштабируемости CI/CD Runner'ов.

**Оркестратор:** **GitLab Self-Managed** (выступает в роли CI/CD оркестратора и хранилища исходного кода).

---

## 1. Архитектура: Hybrid Cloud Model

Система разделена на два домена: **On-Premise Control Core** (для безопасности) и **Elastic Cloud Execution** (для масштабирования).

### 1.1. On-Premise Control Core (Ядро Управления)

Ядро остается локальным для обеспечения максимальной безопасности критических метаданных и секретов.

| Компонент | Технология | Назначение |
| :--- | :--- | :--- |
| **GitLab Master Cluster (HA)** | Self-Managed GitLab | Управление исходным кодом, планирование всех CI/CD задач. |
| **Core DB/Cache** | PostgreSQL/Redis | Хранение состояния GitLab и очередей задач. |
| **IaC Tools** | Terraform / Ansible | Управление локальными ресурсами и оркестрация подключения к Облаку. |

### 1.2. Elastic Cloud Execution Plane (Managed K8s)

Вся нагрузка, связанная со сборкой и исполнением тестов, выносится в облако для **эластичной оплаты (pay-as-you-go)**.

| Компонент | Технология / Функционал | Оценочные Ресурсы и Оплата | Контекстное Сравнение |
| :--- | :--- | :--- | :--- |
| **CI/CD Execution Cluster** | **Managed Kubernetes Service (MKS)** | **Elastic Scaling (Node Pools)**: от 4 до 32 VM (Standard/High-CPU). Оплата по факту потребления. | **Функциональный аналог Яндекс.Managed K8s** (Yandex Managed Kubernetes Service). |
| **Production Cluster** | **Managed Kubernetes Service (MKS)** | Стабильный набор из 3-5 узлов (General Purpose) + Autoscaling. | Продуктивные кластеры, использующие преимущества MKS для балансировки нагрузки. |
| **Cloud Storage** | **Object Storage Service** | Хранение артефактов, образов Docker. Оплата за объем. | Соответствует **Yandex Object Storage (S3-совместимое)**. |
| **Networking** | **VPC** | Dedicated VPC с изолированными подсетями. | Использование облачных сетей для безопасного взаимодействия с On-Premise ядром. |

---

## 2. Детализация CI/CD и Ресурсов

### 2.1. CI/CD Pipeline Logic (GitLab CI)

Пайплайны используют гибридную модель для максимальной эффективности:

1.  **Сборка (Облачный MKS):** Runner'ы, работающие в **Managed K8s**, автоматически масштабируются. Это позволяет минимизировать затраты, так как ресурсы выделяются только на время выполнения задания (Build time).
2.  **Деплой (Hybrid):**
    *   **Staging:** Полностью в облаке, деплой через Helm/ArgoCD.
    *   **Production:** Может использовать либо удаленные узлы MKS, либо локальные VM (`prod-deploy` на On-Premise) для приложений с жесткими требованиями к сетевой задержке.

### 2.2. Ресурсы и Оптимизация Стоимости

Основной принцип экономии — **вычисление в облаке, хранение и контроль — локально**:
*   **Compute:** Максимально тонкая настройка Node Pools в MKS с использованием **Spot Instances** (прерываемые ВМ) для Runner'ов, где это безопасно (например, для юнит-тестов).
*   **Networking:** Трафик между On-Premise и облачными ресурсами оптимизирован через выделенное VPN-соединение.

### 2.3. Технологический Стек (Код)

Код, обслуживаемый этой системой, включает:

*   **TypeScript / TSX:** (65%) — Основной язык разработки приложений.
*   **Python:** (30%) — Скрипты автоматизации, взаимодействие с Terraform и облачными API (включая провайдеры, специфичные для **Яндекс.Облака**).
*   **Go / Bash:** (5%) — Системные утилиты.
